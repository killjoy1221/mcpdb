# mcpdb

A database for mcp accessible via REST

## Quickstart

1. Install python 3.7 and a virtualenv if desired, then install using pip.
    ```
    pip install git+https://github.com/killjoy1221/mcpdb
    ```
2. Generate a secret key to use for token generation. Save it as `SECRET_KEY`
 in either `config.py` or an environment variable.
 
3. Set the `SQLALCHEMY_DATABASE_URI` variable with your database's ODBC
 connection URI. It defaults to a sqlite3 connection, which may not be desired.
 
4. Run the following commands to get started, following the prompts as they
 appear.
    ```
    flask adduser admin
    flask import-tsrg 1.14.4
    flask import-mcp 53-1.14.2
    ```

5. Now run the following command to start the server. Press Ctrl+C to quit.
    ```
    flask run
    ```


#### Notes

- Public user registration has not been implemented, so any new users will need
 to be created by an admin via the `adduser` flask command. 

- If you need to add more versions of MCP, run the `import-tsrg <mcp_version>`
 command again. To mark a version as latest, use the `flask promote <version>`
 command.

## Configuration

See `config.py` for an example configuration and defaults. Alternatively,
 environment variables may be usedd.

## API Usage

Full API documentation is located at `/api` and generated by swagger.

### Authentication

1. Make a `POST` request to `/api/login` with a json payload object containing
    `username` and `password` fields. This will return an empty response with
    status `204` if it was successful.

    a. The header will contain the `Authorization` key. This is your token and
        is needed for all login required api endpoints.

    b. The header will also contain the `Expires` key. This tells you when the
        token will expire.
        
2. For all future requests, supply the `Authorization` header.

### Full Example

**Python + Requests**

```python
#!/usr/bin/env python3
import getpass
import requests

url = "https://mcpdb.myapplication.com"

# Headers for later use
headers = {}

# Obtain username/password from user
username = input("Username: ")
password = getpass.getpass()

# Authorize and get the login token
auth_data = dict(username=username, password=password)
with requests.post(url + "/api/login", json=auth_data) as resp:
    resp.raise_for_status()
    # Successfully logged in, set the header for later
    headers['Authorization'] = resp.headers['Authorization']

# Get the names to set from user.
srg_name = input("SRG Name: ")
new_name = input("New Name: ")

# Now i can set the names how I like.
set_data = dict(mcpname=new_name)
with requests.put(url + '/api/field/' + srg_name, json=set_data, headers=headers) :
    print("Status: " + str(resp.status_code))
    data = resp.json()
    # Print out the server response
    for k, v in data.items():
        print(k + ": " + str(v))
```